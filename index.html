<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CHI'S EMPIRE</title>

<style>
body { font-family: Arial, sans-serif; margin:0; background:#f8fafc; }
header { background:#0f172a; color:#fff; padding:1rem; text-align:center; }

.controls { display:flex; gap:8px; padding:10px; background:#fff; position:sticky; top:0; z-index:10; }
.controls input, .controls select { padding:10px; flex:1; border-radius:8px; border:1px solid #cbd5e1; }

.catalog { padding:1rem; display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:1rem; }

.product { background:#fff; border-radius:12px; padding:10px; box-shadow:0 6px 16px rgba(0,0,0,.08); display:flex; flex-direction:column; align-items:center; text-align:center; position:relative; }
.product img { width:100%; height:180px; object-fit:cover; border-radius:10px; }
.product h3 { font-size:1.1rem; margin:6px 0; }
.meta { font-size:.85rem; color:#64748b; margin-bottom:6px; }
.price { margin:6px 0; font-weight:bold; }
.select-row { display:flex; justify-content:space-between; gap:5px; width:100%; margin:6px 0; }
.select-row select { flex:1; padding:6px; border-radius:6px; border:1px solid #cbd5e1; }

.qty-box { display:flex; align-items:center; gap:8px; margin:6px 0; }
.qty-box button { padding:6px 10px; font-size:1rem; cursor:pointer; }
.btn { background:#25d366; color:#fff; padding:10px 12px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; width:90%; }

.cart-btn { position:fixed; bottom:20px; right:20px; background:#0f172a; color:#fff; padding:16px 20px; border-radius:40px; border:none; z-index:200; font-weight:bold; }

#cartSidebar { position:fixed; top:0; right:-420px; width:380px; height:100%; background:#fff; box-shadow:-8px 0 30px rgba(0,0,0,.25); z-index:1000; transition:right .35s ease; display:flex; flex-direction:column; }
#cartSidebar.open { right:0; }
#cartBox { flex:1; overflow-y:auto; padding:1rem; }
#cartBackdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); opacity:0; pointer-events:none; transition:.3s; z-index:900; }
#cartSidebar.open ~ #cartBackdrop { opacity:1; pointer-events:auto; }
#checkoutBtn { width:100%; padding:14px; font-size:1.05rem; margin-top:10px; cursor:pointer; background:#25d366; color:#fff; border:none; }

@media(max-width:600px){ #cartSidebar{ width:100%; height:85%; bottom:-100%; top:auto; right:0; border-radius:16px 16px 0 0; transition:bottom .35s ease; } #cartSidebar.open{ bottom:0; } }

#toast { position:fixed; bottom:120px; right:20px; background:#25d366; color:#fff; padding:12px 18px; border-radius:8px; opacity:0; transition:.3s; }
#toast.show { opacity:1; }

.badge { padding:4px 8px; border-radius:5px; font-size:12px; color:#fff; display:inline-block; margin-bottom:6px; position:absolute; top:10px; left:10px; }
.low { background:orange; }
.out { background:red; animation:flash 0.7s; }
@keyframes flash { 0%,100%{opacity:1;} 50%{opacity:0;} }

.qty-btn { width:30px; padding:2px 5px; font-weight:bold; margin:0 4px; }
</style>
</head>
<body>

<header>
  <h2>CHI'S EMPIRE</h2>
  <p>Store</p>
</header>

<div class="controls">
  <input id="search" placeholder="Search..." onkeyup="applyFilters()">
  <select id="category" onchange="applyFilters()">
    <option value="All">All</option>
    <option value="Clothing">Clothing</option>
    <option value="Shoes">Shoes</option>
    <option value="Kitchen">Kitchen</option>
  </select>
</div>

<section id="catalog" class="catalog"></section>

<button class="cart-btn" onclick="openCart()">üõí Cart (<span id="cartCount">0</span>)</button>
<div id="toast">Added to cart</div>

<div id="cartSidebar">
  <div id="cartBox">
    <h3>Your Cart</h3>
    <div id="cartItems"></div>
    <p id="cartTotal"></p>

    <h4>Delivery Details</h4>
    <input id="custName" placeholder="Full Name" style="width:100%;padding:10px;margin:6px 0">
    <input id="custPhone" placeholder="Phone Number" style="width:100%;padding:10px;margin:6px 0">
    <input id="custAddress" placeholder="Delivery Address" style="width:100%;padding:10px;margin:6px 0">
    <input id="custCity" placeholder="City / Area" style="width:100%;padding:10px;margin:6px 0">
    <textarea id="custNote" placeholder="Extra note (optional)" style="width:100%;padding:10px;margin:6px 0"></textarea>

    <button id="checkoutBtn" onclick="checkoutWhatsApp()">Checkout on WhatsApp</button>
    <button onclick="closeCart()" style="width:100%;margin-top:8px;">Continue Shopping</button>
  </div>
</div>
<div id="cartBackdrop" onclick="closeCart()"></div>

<script>
const csvURL = "products.csv";
const WHATSAPP_NUMBER = "2347057829344";
const DELIVERY_FEE = 2500;
let products=[], cart=[], qty={};

fetch(csvURL).then(r=>r.text()).then(data=>{
  data.trim().split("\n").slice(1).forEach((r,i)=>{
    const [id,name,category,brand,price,colors,sizes,stock,image,discount]=r.split(",");
    products.push({id,name,category,brand,price:+price,colors:colors.split("|"),sizes:sizes.split("|"),stock:+stock,image,discount:+discount||0});
    qty[i]=1;
  });
  loadCart();
  renderProducts(products);
  renderCart();
  updateCartCount();
});

function saveCart(){ localStorage.setItem("cartData",JSON.stringify(cart)); localStorage.setItem("stockData",JSON.stringify(products)); }
function loadCart(){ const c=localStorage.getItem("cartData"); const s=localStorage.getItem("stockData"); if(c) cart=JSON.parse(c); if(s) products=JSON.parse(s); }

function renderProducts(list){
  catalog.innerHTML="";
  list.forEach((p,i)=>{
    let badge="";
    if(p.stock<=0) badge=`<div class="badge out">Out of Stock</div>`;
    else if(p.stock<=5) badge=`<div class="badge low">Low Stock</div>`;
    const price = p.discount || p.price;
    catalog.innerHTML+=`
      <div class="product">
        ${badge}
        <img src="${p.image}">
        <h3>${p.name}</h3>
        <div class="meta">${p.brand} ‚Ä¢ ${p.category}</div>
        <div class="price">‚Ç¶${price}</div>
        <div class="select-row">
          <select id="size-${p.id}">${p.sizes.map(s=>`<option>${s}</option>`).join("")}</select>
          <select id="color-${p.id}">${p.colors.map(c=>`<option>${c}</option>`).join("")}</select>
        </div>
        <div class="qty-box">
          <button onclick="chg(${i},-1)">‚ûñ</button>
          <span id="q${i}">${qty[i]}</span>
          <button onclick="chg(${i},1)">‚ûï</button>
        </div>
        <button class="btn" onclick="addToCart(${i})" ${p.stock<=0?'disabled':''}>Add to Cart</button>
      </div>`;
  });
}

function chg(i,d){ qty[i]+=d; if(qty[i]<1) qty[i]=1; document.getElementById("q"+i).innerText=qty[i]; }

function addToCart(i){
  const p = products[i];
  const color = document.getElementById(`color-${p.id}`).value;
  const size = document.getElementById(`size-${p.id}`).value;
  let q = qty[i]; if(q>p.stock){ alert("Not enough stock"); return; }

  const f = cart.find(x=>x.id==p.id && x.color==color && x.size==size);
  if(f) f.qty+=q; else cart.push({id:p.id,name:p.name,price:p.price,color,size,qty:q});

  p.stock-=q; qty[i]=1; document.getElementById("q"+i).innerText=1;
  renderProducts(products); renderCart(); updateCartCount(); saveCart();
  toast.classList.add("show"); setTimeout(()=>toast.classList.remove("show"),1200);
}

function renderCart(){
  let html="", sub=0;
  cart.forEach((item,n)=>{
    const t=item.price*item.qty; sub+=t;
    html+=`<div style="border-bottom:1px solid #e5e7eb;padding:8px 0">
      <b>${item.name}</b> (${item.color},${item.size})
      <div style="display:flex;align-items:center;gap:5px;margin-top:4px">
        <button class="qty-btn" onclick="mod(${n},-1)">-</button>
        ${item.qty}
        <button class="qty-btn" onclick="mod(${n},1)">+</button>
        <span style="margin-left:auto">‚Ç¶${t}</span>
        <button onclick="del(${n})">‚ùå</button>
      </div></div>`;
  });
  cartItems.innerHTML = html || "<p>Cart empty</p>";
  cartTotal.innerHTML = `Subtotal ‚Ç¶${sub}<br>Delivery ‚Ç¶${cart.length?DELIVERY_FEE:0}<br><b>Total ‚Ç¶${cart.length?sub+DELIVERY_FEE:0}</b>`;
}

function mod(i,d){
  const item=cart[i]; const p=products.find(x=>x.id==item.id);
  if(d>0 && p.stock<=0) return alert("No more stock");
  if(d<0 && item.qty<=1) return;
  item.qty+=d; p.stock-=d;
  if(item.qty<=0) cart.splice(i,1);
  renderProducts(products); renderCart(); updateCartCount(); saveCart();
}

function del(i){ const item=cart[i]; const p=products.find(x=>x.id==item.id); p.stock+=item.qty; cart.splice(i,1); renderProducts(products); renderCart(); updateCartCount(); saveCart(); }

function openCart(){ cartSidebar.classList.add("open"); }
function closeCart(){ cartSidebar.classList.remove("open"); }
function updateCartCount(){ cartCount.innerText=cart.length; }

function checkoutWhatsApp(){
  if(!cart.length) return alert("Cart empty");
  if(!custName.value||!custPhone.value||!custAddress.value||!custCity.value) return alert("Fill delivery details");

  let msg=`üßæ New Order%0AName: ${custName.value}%0APhone: ${custPhone.value}%0AAddress: ${custAddress.value}, ${custCity.value}%0ANote: ${custNote.value || "None"}%0A%0A`;
  cart.forEach((item,n)=>{ msg+=`${n+1}. ${item.name} (${item.color},${item.size}) x${item.qty} ‚Ç¶${item.price*item.qty}%0A`; });
  let subtotal = cart.reduce((a,b)=>a+b.price*b.qty,0);
  msg+=`%0ATOTAL ‚Ç¶${subtotal + DELIVERY_FEE}`;
  window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`,"_blank");

  // Update stock
  cart.forEach(item=>{
    const p = products.find(x=>x.id==item.id);
    if(p) p.stock -= item.qty;
    if(p.stock<0) p.stock=0;
  });

  cart=[]; renderCart(); updateCartCount(); renderProducts(products); saveCart();
}

function applyFilters(){
  const s=search.value.toLowerCase(); const c=category.value;
  renderProducts(products.filter(p=>p.name.toLowerCase().includes(s)&&(c=="All"||p.category==c)));
}
</script>
</body>
</html>
