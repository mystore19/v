<script>
const csvURL = "products.csv";
const WHATSAPP_NUMBER = "2347057829344";
const DELIVERY_FEE = 2500;

let products=[], cart=[], qty={};

// Load CSV and render
fetch(csvURL).then(r=>r.text()).then(data=>{
  data.trim().split("\n").slice(1).forEach((r,i)=>{
    const [id,name,category,brand,price,colors,sizes,stock,image,discount]=r.split(",");
    products.push({
      id, name, category, brand, price:+price, 
      colors:colors.split("|"), sizes:sizes.split("|"), 
      stock:+stock, image, discount:+discount||0
    });
    qty[i]=1;
  });

  loadCart();          // Load saved cart from localStorage
  renderProducts(products);
  renderCart();
  updateCartCount();
});

// ---------------------- CART PERSISTENCE ----------------------

// Save cart to localStorage
function saveCart(){
  localStorage.setItem("cartData", JSON.stringify(cart));
  localStorage.setItem("stockData", JSON.stringify(products));
}

// Load cart from localStorage
function loadCart(){
  const savedCart = localStorage.getItem("cartData");
  const savedStock = localStorage.getItem("stockData");

  if(savedCart) cart = JSON.parse(savedCart);
  if(savedStock) products = JSON.parse(savedStock);
}

// ---------------------- PRODUCT RENDER ----------------------
function renderProducts(list){
  catalog.innerHTML="";
  list.forEach((p,i)=>{
    let badge = "";
    if(p.stock<=0){ badge=`<div class="badge out">Out of Stock</div>`; }
    else if(p.stock<=5){ badge=`<div class="badge low">Low Stock</div>`; }

    const price = p.discount || p.price;

    catalog.innerHTML+=`
    <div class="product">
      ${badge}
      <img src="${p.image}">
      <h3>${p.name}</h3>
      <div class="meta">${p.brand} ‚Ä¢ ${p.category}</div>
      <div class="price"><b>‚Ç¶${price}</b></div>
      <select id="color-${p.id}">${p.colors.map(c=>`<option>${c}</option>`).join("")}</select>
      <select id="size-${p.id}">${p.sizes.map(s=>`<option>${s}</option>`).join("")}</select>
      <div class="qty-box">
        <button onclick="chg(${i},-1)">‚ûñ</button>
        <span id="q${i}">${qty[i]}</span>
        <button onclick="chg(${i},1)">‚ûï</button>
      </div>
      <button class="btn" onclick="addToCart(${i})" ${p.stock<=0?'disabled':''}>Add to Cart</button>
    </div>`;
  });
}

// Quantity selector
function chg(i,d){ 
  qty[i]+=d; 
  if(qty[i]<1) qty[i]=1; 
  document.getElementById("q"+i).innerText=qty[i]; 
}

// Add to cart
function addToCart(i){
  const p = products[i];
  const selectedColor = document.getElementById(`color-${p.id}`).value;
  const selectedSize = document.getElementById(`size-${p.id}`).value;
  let q = qty[i];
  if(q>p.stock){ alert("Not enough stock"); return; }

  const f = cart.find(x=>x.id==p.id && x.color==selectedColor && x.size==selectedSize);
  if(f) f.qty += q;
  else cart.push({id:p.id,name:p.name,price:p.price,color:selectedColor,size:selectedSize,qty:q});

  p.stock -= q;
  qty[i]=1; document.getElementById("q"+i).innerText=1;
  renderProducts(products);
  renderCart();
  updateCartCount();
  saveCart();  // persist changes
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"),1200);
}

// Render cart drawer
function renderCart(){
  let html="", sub=0;
  cart.forEach((item,n)=>{
    const t = item.price*item.qty;
    sub+=t;
    html+=`
    <div style="border-bottom:1px solid #e5e7eb;padding:8px 0">
      <b>${item.name}</b> (${item.color},${item.size})
      <div style="display:flex;align-items:center;gap:5px;margin-top:4px">
        <button class="qty-btn" onclick="mod(${n},-1)">-</button>
        ${item.qty}
        <button class="qty-btn" onclick="mod(${n},1)">+</button>
        <span style="margin-left:auto">‚Ç¶${t}</span>
        <button onclick="del(${n})">‚ùå</button>
      </div>
    </div>`;
  });
  cartItems.innerHTML = html || "<p>Cart empty</p>";
  cartTotal.innerHTML = `Subtotal ‚Ç¶${sub}<br>Delivery ‚Ç¶${cart.length?DELIVERY_FEE:0}<br><b>Total ‚Ç¶${cart.length?sub+DELIVERY_FEE:0}</b>`;
}

// Modify quantity in cart
function mod(i,d){
  const item = cart[i];
  const p = products.find(x=>x.id==item.id);
  if(d>0 && p.stock<=0) return alert("No more stock");
  if(d<0 && item.qty<=1) return;
  item.qty += d;
  p.stock -= d;
  if(item.qty<=0) cart.splice(i,1);
  renderProducts(products);
  renderCart();
  updateCartCount();
  saveCart();
}

// Delete item
function del(i){
  const item = cart[i];
  const p = products.find(x=>x.id==item.id);
  p.stock += item.qty;
  cart.splice(i,1);
  renderProducts(products);
  renderCart();
  updateCartCount();
  saveCart();
}

// Cart drawer controls
function openCart(){ cartSidebar.classList.add("open"); }
function closeCart(){ cartSidebar.classList.remove("open"); }
function updateCartCount(){ cartCount.innerText = cart.length; }

// WhatsApp Checkout
function checkoutWhatsApp(){
  if(!cart.length) return alert("Cart empty");
  if(!custName.value||!custPhone.value||!custAddress.value||!custCity.value) return alert("Fill delivery details");

  let msg=`üßæ New Order%0AName: ${custName.value}%0APhone: ${custPhone.value}%0AAddress: ${custAddress.value}, ${custCity.value}%0ANote: ${custNote.value || "None"}%0A%0A`;
  cart.forEach((item,n)=>{ msg+=`${n+1}. ${item.name} (${item.color},${item.size}) x${item.qty} ‚Ç¶${item.price*item.qty}%0A`; });
  let subtotal = cart.reduce((a,b)=>a+b.price*b.qty,0);
  msg+=`%0ATOTAL ‚Ç¶${subtotal + DELIVERY_FEE}`;
  window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`,"_blank");

  cart=[]; renderCart(); updateCartCount(); renderProducts(products); saveCart();
}

// Search & Filter
function applyFilters(){
  const s = search.value.toLowerCase();
  const c = category.value;
  renderProducts(products.filter(p=>p.name.toLowerCase().includes(s) && (c=="All" || p.category==c)));
}
</script>
